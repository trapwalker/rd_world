__cls__: KillerQuest
_cls: KillerQuest
doc    : Примеры квестов

list_icon: static/img/quests/icons/players_kill.png

# Настройки параметров квеста
# Квест на убийство игроков, имеющих минимальный уровень (равный уровню квеста),
# и карму не выше заданной (тоже зависит от уровня квеста, чем выше уровень квеста, тем ниже карма должна быть у жертвы)
# deadline - Время в секундах на убийство одной цели на 0 уровне квеста
max_karma_victims_start: 100 # Стартовое значение кармы для 0 уровня квеста
max_karma_victims_by_lvl: 10  # Сколько кармы от стартовой будет отнимать каждый лвл квеста
deadline_koeff_by_lvl: 0.1  # На сколько больше времени будет выдаваться на каждую жертву в зависимости от уровня квеста
price_victim_koeff_by_lvl: 0.1  # На сколько больше будет суммарная награда в зависимости от уровня квеста
reward_relation_hirer: 2  # Награда в отношения с НПС, выдавшим квест


first_state: begin
current_state: ~

caption: Охота за головами
text: |
    Данный текст задаётся в методе init_text

#    text_short = StringField(tags='client', caption=u'Короткий текст квеста', doc=u'Может строиться и меняться по шаблону')
#    typename = StringField(tags='client', caption=u'Тип квеста', doc=u'Может быть произвольным')
#    list_icon = StringField(tags='client', caption=u'Пиктограмма для списков', doc=u'Мальенькая картинка для отображения в списках')  # todo: use UrlField
#    level = IntField(tags='client', caption=u'Уровень квеста', doc=u'Обычно число, но подлежит обсуждению')  # todo: обсудить
#    starttime = DateTimeField(tags='client', caption=u'Начало выполнения', doc=u'Время старта квеста')
#    deadline = DateTimeField(tags='client', caption=u'Срок выполнения этапа', doc=u'datetime до провала текущего этапа. Может меняться')

#    hirer = UniReferenceField(tags='client', caption=u'Заказчик', doc=u'NPC-заказчик квеста')
#    town = UniReferenceField(tags='client', caption=u'Город выдачи', doc=u'Город выдачи квеста')
#    agent = UniReferenceField(tags='client', caption=u'Агент', doc=u'Исполнитель квеста')

on_generate: |
    if not quest.can_generate(event):
        raise Cancel("QUEST CANCEL: reason: generate rules")

    # Установить уровень квеста, условия выполнения (определение жертв) и дедлайн
    quest.init_level()
    quest.init_targets_info()
    quest.init_deadline()

    # Рассчитываем общую награду квеста - зависит от уровня квеста
    quest.total_reward_money = quest.count_to_kill * quest.price_victim * (1 + quest.level * quest.price_victim_koeff_by_lvl)
    quest.generate_reward()  # Устанавливаем награду за квест (карму, деньги и итемы)
    quest.init_text()


on_start: |
    if quest.get_available_lvl() < quest.level:
        quest.npc_replica(npc=quest.hirer, replica=u"NPC не достаточно хорошо к Вам относится.", event=event)
        log("KillerQuest: User have not enough relation")
        raise Cancel("KillerQuest: User have not enough relation")
    quest.starttime = event.time
    # Создание ноты для квеста
    quest.wanted_note_uid = agent.profile.add_note(
        quest_uid=quest.uid,
        note_class=NPCWantedNote,
        time=event.time,
        npc=quest.hirer,
        page_caption='Задание на убийство',
    )

states:
    - id: begin
      parent: reg:///registry/quest_states/test/begin

      on_enter: |
          # Создание таймера deadline на убийство
          if quest.deadline:
              set_timer(name='deadline_killer_quest', delay=quest.deadline)

      on_event: |
          if isinstance(event, OnKill):
              if ((event.agent.profile.karma <= quest.max_karma_victims and)
                  (event.agent.profile.get_real_lvl() >= quest.min_level_victims) and
                  (not quest.unique_victims or not quest.in_victims(event.agent))):
                  quest.append_victim(event.agent, event)  # todo: Исправить добавление агента 
                  quest.log(text=u'{} убит.'.format(event.agent.login), event=event, position=quest.hirer.hometown.position)
                  if len(quest.victims) >= quest.count_to_kill:
                      go('note_kill_reward')

          if isinstance(event, OnTimer) and event.name == 'deadline_killer_quest':
              agent.profile.del_note(uid=quest.wanted_note_uid, time=event.time)
              go("deadline_fail")

          if isinstance(event, OnCancel):
              penalty_money = quest.reward_money / 2.
              if agent.profile.balance >= penalty_money:
                  agent.profile.del_note(uid=quest.wanted_note_uid, time=event.time)
                  agent.profile.set_balance(time=event.time, delta=-penalty_money)
                  quest.log(text=u'Уплачен штраф в размере {}nc.'.format(penalty_money), event=event, position=quest.hirer.hometown.position)
                  go("cancel_fail")
              else:
                 quest.npc_replica(npc=quest.hirer, replica=u"Для отказа от квеста заплатите штраф {}nc.".format(penalty_money), event=event)


    - id: note_kill_reward
      parent: reg:///registry/quest_states/test/begin
      
      on_event: |
          if isinstance(event, OnNote):
              if (quest.wanted_note_uid == event.note_uid) and (event.result == True):
                  agent.profile.del_note(uid=quest.wanted_note_uid, time=event.time)
                  go('reward')

    # todo: если будет ещё один квест с точно таким же состоянием, но отличающимся нпц, то вынести стейт отдельно и
    # просто его наследовать, при этом в on_generate прописывать поле reward_npc
    - id: reward
      parent: reg:///registry/quest_states/test

      on_enter: |
          quest.agent.profile.set_balance(time=event.time, delta=quest.reward_money)
          quest.agent.profile.set_karma(time=event.time, dvalue=quest.reward_karma)
          quest.log(text=u'Получено вознаграждение в размере {:.0f}nc. и {:.0f} кармы'.format(quest.reward_money, quest.reward_karma), event=event, position=quest.hirer.hometown.position)
          agent.profile.set_relationship(time=event.time, npc=quest.hirer, dvalue=quest.reward_relation_hirer)  # изменение отношения к нпц
          if len(quest.reward_items) > 0:
              quest.reward_note_uid = agent.profile.add_note(
                  quest_uid=quest.uid,
                  note_class=NPCRewardItemsNote,
                  time=event.time,
                  npc=quest.hirer,
                  page_caption=u'Награда',
                  btn1_caption=u'<br>Забрать',
              )
          else:
              go('win')

      on_event: |
          if isinstance(event, OnNote):
              if (event.note_uid == quest.reward_note_uid) and (event.result == True):
                  if quest.give_items(items=quest.reward_items, event=event):
                      agent.profile.del_note(uid=quest.reward_note_uid, time=event.time)
                      go('win')
                  else:
                      quest.npc_replica(npc=quest.hirer, replica=u"Не хватает места в инвентаре.", event=event)

    - id: cancel_fail
      parent: reg:///registry/quest_states/final/fail/cancel
      on_enter: |
          quest.log(text=u'Квест провален: отказ от выполнения.', event=event)

    - id: deadline_fail
      parent: reg:///registry/quest_states/final/fail
      on_enter: |
          agent.profile.set_relationship(time=event.time, npc=quest.hirer, dvalue=-quest.level * 2)  # изменение отношения c нпц
          quest.log(text=u'Квест провален: время вышло.', event=event)

    - id: win
      parent: reg:///registry/quest_states/final/win
      on_enter: |
          quest.log(text=u'Квест выполнен.', event=event)
