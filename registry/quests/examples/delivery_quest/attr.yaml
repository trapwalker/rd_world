__cls__: DeliveryQuest
doc    : Примеры квестов

first_state: begin
current_state: ~

caption: Доставка груза
text: |
    Доставьте груз.

#    text_short = StringField(tags='client', caption=u'Короткий текст квеста', doc=u'Может строиться и меняться по шаблону')
#    typename = StringField(tags='client', caption=u'Тип квеста', doc=u'Может быть произвольным')
#    list_icon = StringField(tags='client', caption=u'Пиктограмма для списков', doc=u'Мальенькая картинка для отображения в списках')  # todo: use UrlField
#    level = IntField(tags='client', caption=u'Уровень квеста', doc=u'Обычно число, но подлежит обсуждению')  # todo: обсудить
#    starttime = DateTimeField(tags='client', caption=u'Начало выполнения', doc=u'Время старта квеста')
#    deadline = DateTimeField(tags='client', caption=u'Срок выполнения этапа', doc=u'datetime до провала текущего этапа. Может меняться')

#    hirer = UniReferenceField(tags='client', caption=u'Заказчик', doc=u'NPC-заказчик квеста')
#    town = UniReferenceField(tags='client', caption=u'Город выдачи', doc=u'Город выдачи квеста')
#    agent = UniReferenceField(tags='client', caption=u'Агент', doc=u'Исполнитель квеста')

on_generate: |
    # todo: реализовать метод same_as для проверки похожести квестов
    for q in agent and agent.quests or []:
        if q.parent == quest.parent:
            if q.status is None:
                raise Cancel("QUEST CANCEL: You already have that unstarted quest: {q}")
            if q.status == 'active':
                raise Cancel("QUEST CANCEL: You already have more <<quest.active_count_max>> copies of that quest.")

    if (len(quest.recipient_list) == 0) or (len(quest.delivery_set_list) == 0):
        raise Cancel("QUEST CANCEL: Empty recipient_list or empty delivery_set_list.")

    quest.recipient = quest.recipient_list[random.randint(0, len(quest.recipient_list) - 1)]
    quest.delivery_set = quest.delivery_set_list[random.randint(0, len(quest.delivery_set_list) - 1)]

on_start: |
    if not quest.give_items(items=quest.delivery_set, event=event):
        quest.npc_replica(npc=quest.hirer, replica=u"Не хватает места в инвентаре.", event=event)
        log("DELIVERY QUEST: User have not enough empty slots")
        raise Cancel("QUEST CANCEL: User have not enough empty slot")

states:
    - id: begin
      parent: reg:///registry/quest_states/test/begin
      on_enter: |
          quest.delivery_note_uid = agent.add_note(
              quest_uid=quest.uid,
              note_class=NPCDeliveryNote,
              time=event.time,
              npc=quest.recipient,
              page_caption='Доставка',
          )
          go('delivery')

    - id: delivery
      parent: reg:///registry/quest_states/test
      on_event: |
          if isinstance(event, OnNote):
              if (event.note_uid == quest.delivery_note_uid) and (event.result == True) and quest.take_items(items=quest.delivery_set, event=event):
                  go('final')

    - id: final
      parent: reg:///registry/quest_states/final/win

      on_enter: |
          # todo: reward
          agent.set_balance(time=event.time, delta=2000)
          agent.del_note(uid=quest.delivery_note_uid, time=event.time)
